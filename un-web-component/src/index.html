<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
    <title>Stencil Component Starter</title>

    <script type="module" src="/build/stencil-starter-project-name.esm.js"></script>
    <script nomodule src="/build/stencil-starter-project-name.js"></script>

    <link rel="stylesheet" href="https://js.arcgis.com/4.18/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.18/"></script>

    <script type="module" src="https://unpkg.com/@esri/calcite-components@1.0.0-beta.48/dist/calcite/calcite.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/@esri/calcite-components@1.0.0-beta.48/dist/calcite/calcite.js"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@esri/calcite-components@1.0.0-beta.48/dist/calcite/calcite.css" />

    <style>
      html,
      body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      }
      #viewDiv {
      height: 75%;
      width: 75%;
      margin: 0;
      padding: 0;
      }
      #optionsDiv {
      background-color: white;
      color: black;
      padding: 6px;
      max-width: 400px;
      }
    </style>
    <script>
      require([
        "esri/Map",
        "esri/config",
        "esri/Graphic",
        "esri/WebMap",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/widgets/Legend",
        "esri/identity/IdentityManager",
        "esri/widgets/Sketch",
        "esri/geometry/projection"
      ], function(Map, esriConfig, Graphic, WebMap, MapView, FeatureLayer, GraphicsLayer, Legend, IdentityManager, Sketch, projection) {
        // Crime in SF
        IdentityManager.registerToken({
          server: "https://dev0016770.esri.com/portal",
          token: "_pNHgZFzgcjkhhHIp3jKdZyvhU88nb88BYI3WKh42wmrL-IaXjT_NUUns0NlYBjtPQNzxtenWqKYjEX2iNjG4kyGiZt2F3T3CELpIYaICFmyORcxyUmputs2axXFcMCSuyLWMRMiUv94FgOGmgeR3BEMeyCzNoNgBlOP5yGfV05XqGq7NsWbqVBQbpdlVsjz"
        });

        const gl = new GraphicsLayer();

        esriConfig.portalUrl = "https://dev0016770.esri.com/portal";
        const webmap = new WebMap({
          portalItem: { // autocasts as new PortalItem()
            id: "a80e69210ed34485995f0aa8362f539b"
          }
        });

        webmap.add(gl);

        var view = new MapView({
          container: "viewDiv",
          map: webmap,
          zoom: 15,
          center: [-88.1663, 41.772275]
        });


        const sketch = new Sketch({
          layer: gl,
          view: view,
          // graphic will be selected as soon as it is created
          creationMode: "update"
        });

        view.ui.add(sketch, "top-right");

        // additional query fields initially set to null for basic query
        var distance = null;
        var units = null;

        // Listen to sketch widget's create event.
        sketch.on("create", function(event) {
          // check if the create event's state has changed to complete indicating
          // the graphic create operation is completed.
          if (event.state === "complete") {
            console.log(event.graphic);
            // remove the graphic from the layer. Sketch adds
            // the completed graphic to the layer by default.
            //gl.remove(event.graphic);

            // use the graphic.geometry to query features that intersect it
            //selectFeatures(event.graphic.geometry);
            let layerGroup = [];

            const traceComponent = document.querySelector('un-trace-manager');
            traceComponent.inAssets = [{"type":'start', "geometry":event.graphic.geometry, "layers":layerGroup}];

          }
        });


        //create graphic for mouse point click
        var pointGraphic = new Graphic({
          symbol: {
            type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
            color: [255, 0, 0],
            outline: {
              color: [255,255,255],
              width: 1.5
            }
          }
        });

        // Create graphic for distance buffer
        var bufferGraphic = new Graphic({
          symbol: {
            type: "simple-fill", // autocasts as new SimpleFillSymbol()
            color: [173, 216, 230, 0.2],
            outline: {
              // autocasts as new SimpleLineSymbol()
              color: [255, 255, 255],
              width: 1
            }
          }
        });

        function queryFeatures(screenPoint, componentProps) {
          const point = view.toMap(screenPoint);
          layer.queryFeatures({
            geometry: point,
            // distance and units will be null if basic query selected
            distance: 10,
            units: 'feet',
            spatialRelationship: "intersects",
            returnGeometry: true,
            returnQueryGeometry: true,
            outFields: ["*"],
          })
          .then(function(featureSet) {
            // set graphic location to mouse pointer and add to mapview
            console.log(featureSet);
            console.log("Outside component: click on map, query, send back to component");

            //componentProps.detail.callback(point);
            pointGraphic.geometry = point;
            view.graphics.add(pointGraphic);
            // open popup of query result
            view.popup.open({
              location: point,
              features: featureSet.features,
              featureMenuOpen: true
            });
          });
        }

        function getDataForComponent(screenPoint, componentProps) {

          const point = view.toMap(screenPoint);

          view.hitTest(screenPoint).then(function (response) {
            if (response.results.length > 0) {
              console.log(response.results);
              let layerGroup = [];
              response.results.map((r) => {
                if(r.graphic.layer.hasOwnProperty('layerId')) {
                  let assetGroups = [];
                  let objectIds = [];
                  objectIds.push(r.graphic.attributes.objectid);
                  layerGroup.push({
                  'layerId': r.graphic.layer.layerId,
                  'subtypes': assetGroups,
                  'ids': objectIds
                  });
                }
              });

              const traceComponent = document.querySelector('un-trace-manager');
              traceComponent.inAssets = [{"type":'start', "geometry":point, "layers":layerGroup}];

            }
          });
          //console.log(webmap.layers);
          webmap.layers.map((lyr) => {
            //console.log(lyr.title + "    vis:" + lyr.visible);
            if(lyr.hasOwnProperty("layers")) {
              lyr.layers.map((ll) => {
              //console.log("     " + ll.title + "    vis:" + ll.visible);
            });
            }
          });
          pointGraphic.geometry = point;
          view.graphics.add(pointGraphic);

        }

        setTimeout(() => {
          const domElement = document.querySelector('un-trace-manager');
          domElement.addEventListener('emitQueryTrace', event => {
            console.log('query traces emit');
          });

          domElement.addEventListener('emitSelectedTrace', event => {
            console.log('Selected trace emit');
          });

          domElement.addEventListener('emitTraceResults', event => {
            console.log('query traces results');
          });

          domElement.addEventListener('emitFlagChange', event => {
            console.log('Outside Component: receive flag button click, activate map click');
            //console.log(event);
            view.on("click", function(e) {
              view.graphics.remove(pointGraphic);
              getDataForComponent(e,event);
            });
          });

          domElement.addEventListener('emitDrawComplete', event => {
            console.log('query complete from drawn input inside component.  flags are returned');
            console.log(event.detail);
            projection.load().then(() => {
              if(event.detail.geometry.length > 0) {
                event.detail.geometry.map((e) => {
                  const projGeom = projection.project(e, MapView.spatialReference);
                  var flagGraphic = new Graphic({
                    symbol: {
                      type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
                      color: [255, 0, 0],
                      outline: {
                        color: [255,255,255],
                        width: 1.5
                      }
                    }
                  });
                  flagGraphic.geometry = projGeom;
                  view.graphics.add(flagGraphic);
                });
              }
            });
          });

        },1000);

        //[{"type":start, "geom":null, "layers":[{"layerId":0, "assetGroups":[0,1,2], "objectId":[e123]}]}]

      });
    </script>
  </head>
  <body>
      <un-trace-manager
      show-terminals=true
      host="https://dev0016770.esri.com"
      webmap="a80e69210ed34485995f0aa8362f539b"
      name="Water_Distribution_Utility_Network" >
    </un-trace-manager>
    <div id="viewDiv"></div>
  </body>
</html>